<?php

$POSICION = (isset($POSICION) ? $POSICION : "");
while (!file_exists($POSICION."conexion.php")) {
    $POSICION.="../";
}

require($POSICION."conexion.php");
require($POSICION."componente/datagrid3/class.php");

$DG = new DATAGRID("documento");

$DG->onInitialize = "DataGrid_onInitialize";
$DG->onCreate     = "DataGrid_onCreate";

$DG->sqlLimit    = 20;

$DG->sqlQuery    = "SELECT 
                        d.iddocumento,
                        d.folio,
                        d.tipomovimiento,
                        td.descripcion as tipo_documento,
                        cp.rut as cliente_rut,
                        d.fechadocumento,
                        d.montototal
                    FROM public.documento d
                    LEFT JOIN public.tipodocumento td ON d.tipodocumento = td.tipodocumento
                    LEFT JOIN public.clienteproveedor cp ON d.idclienteproveedor = cp.idclienteproveedor
                    ORDER BY d.fechadocumento DESC";

// Obtener SYSKEY para generar enlaces PDF
$RS = $Base->query("SELECT p.key FROM preferencias p;");
$row = $Base->to_object($RS);
$SYSKEY = $row->key;

// Función para generar link PDF
function getLinkPDF($tipomovimiento, $iddocumento, $cedible = true) {
    global $POSICION, $SYSKEY;
    $cedible = $cedible == true ? "true" : "false";
    $key = $SYSKEY;
    $metodo = "GDIPDF";
    
    $K = (md5($key . $metodo . $tipomovimiento . $iddocumento . $cedible));
    $K = substr($K, 0, 10);
    
    $linkPDF = $POSICION . "descargar.php?p1=" . $K . "&p2=" . $metodo . "&m=" . $tipomovimiento . "&i=" . $iddocumento . "&c=" . $cedible;
    return ($linkPDF);
}

// Clase para columna Folio con botón de descarga PDF
class Folio extends DATAGRID_COL
{
    public function Folio($id = "folio")
    {
        $this->head = "Folio";
        $this->width = "15%";
        $this->orderby = "folio";
        $this->filter = "folio";
        $this->type = "varchar";
    }

    public function getValue()
    {
        $folio = $this->row["folio"];
        $iddocumento = $this->row["iddocumento"];
        $tipomovimiento = $this->row["tipomovimiento"];
        
        $linkPDF = getLinkPDF($tipomovimiento, $iddocumento, true);
        
        return ('<center>
                    <button type="button" class="btn btn-primary btn-sm" onclick="window.open(\''.$linkPDF.'\', \'_blank\')">
                        <i class="fa fa-file-pdf-o"></i> '.$folio.'
                    </button>
                </center>');
    }
}

// Clase para columna Documento
class TipoDocumento extends DATAGRID_COL
{
    public function TipoDocumento($id = "tipo_documento")
    {
        $this->head = "Documento";
        $this->width = "20%";
        $this->orderby = "tipo_documento";
        $this->filter = "tipo_documento";
        $this->type = "varchar";
    }

    public function getValue()
    {
        $documento = $this->row["tipo_documento"];
        return ('<center>'.$documento.'</center>');
    }
}

// Clase para columna RUT Cliente
class ClienteRut extends DATAGRID_COL
{
    public function ClienteRut($id = "cliente_rut")
    {
        $this->head = "RUT (Cliente)";
        $this->width = "15%";
        $this->orderby = "cliente_rut";
        $this->filter = "cliente_rut";
        $this->type = "varchar";
    }

    public function getValue()
    {
        $rut = $this->row["cliente_rut"];
        return ('<center>'.$rut.'</center>');
    }
}

// Clase para columna Fecha Documento
class FechaDocumento extends DATAGRID_COL
{
    public function FechaDocumento($id = "fechadocumento")
    {
        $this->head = "Fecha Documento";
        $this->width = "20%";
        $this->orderby = "fechadocumento";
        $this->filter = "fechadocumento";
        $this->type = "date";
    }

    public function getValue()
    {
        $fecha = $this->row["fechadocumento"];
        // Formatear fecha si es necesario
        if ($fecha) {
            $fechaFormateada = date("d/m/Y", strtotime($fecha));
            return ('<center>'.$fechaFormateada.'</center>');
        }
        return ('<center>-</center>');
    }
}

// Clase para columna Monto Total
class MontoTotal extends DATAGRID_COL
{
    public function MontoTotal($id = "montototal")
    {
        $this->head = "Monto Total";
        $this->width = "20%";
        $this->orderby = "montototal";
        $this->filter = "montototal";
        $this->type = "numeric";
    }

    public function getValue()
    {
        $monto = $this->row["montototal"];
        if ($monto !== null && $monto !== '') {
            // Formatear monto con separadores de miles
            $montoFormateado = number_format($monto, 0, ',', '.');
            return ('<center>$'.$montoFormateado.'</center>');
        }
        return ('<center>$0</center>');
    }
}

// Agregar columnas al DataGrid
$DG->addCol(new Folio("folio"));
$DG->addCol(new TipoDocumento("tipo_documento"));
$DG->addCol(new ClienteRut("cliente_rut"));
$DG->addCol(new FechaDocumento("fechadocumento"));
$DG->addCol(new MontoTotal("montototal"));

if (($_SERVER['HTTP_DG3'] == $DG->id) || ($_SERVER['HTTP_USER_AGENT'] == $DG->id)) {
    $DG->reload();
}

require($POSICION."formHeader.php");
?>

<style>
.btn-primary {
    background-color: #007bff;
    border-color: #007bff;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    text-decoration: none;
    cursor: pointer;
    border: none;
    font-size: 12px;
}

.btn-primary:hover {
    background-color: #0056b3;
    border-color: #004085;
}

.btn-sm {
    padding: 2px 6px;
    font-size: 11px;
}

.fa-file-pdf-o:before {
    content: "📄";
}
</style>

<script type="text/javascript">
    function DataGrid_onInitialize() {
        // Inicialización del DataGrid
    }

    function reziseDataGrid(dg) {
        // Con esto, ocultamos las barras de desplazamiento innecesarias
        document.body.style.overflowX = "hidden";
    }

    /**
     * Función a ejecutarse al momento de inicializarse datagrid. Definida por $DG->onCreate = "DataGrid_onCreate";
     */
    function DataGrid_onCreate() {
        reziseDataGrid(this);
        this.reload();
    }
</script>

<div>
    <h3>Grilla de Documentos</h3>
    <?php $DG->Create();?>
</div>

<?php require($POSICION."formFoot.php"); ?>